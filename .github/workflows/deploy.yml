name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
    
    - name: Build
      run: npm run build
    
    - name: Create deployment package
      run: |
        mkdir -p deployment-package
        cp -r src/ deployment-package/
        cp package*.json deployment-package/
        cp ecosystem.config.cjs deployment-package/
        cp -r .github/ deployment-package/ 2>/dev/null || true
        
        # Handle .env file
        if [ -f "production.env" ]; then
          cp production.env deployment-package/.env
        elif [ -f ".env.production" ]; then
          cp .env.production deployment-package/.env
        elif [ -f ".env" ]; then
          cp .env deployment-package/.env
        else
          echo "No .env file found, using example"
          cp .env.example deployment-package/.env 2>/dev/null || true
        fi
        
        tar -czf backend-deployment.tar.gz deployment-package/
    
    - name: Deploy to Server
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Deploy files
        scp -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key \
          backend-deployment.tar.gz \
          $SERVER_USER@$SERVER_HOST:/tmp/
        
        # Extract and setup on server
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key \
          $SERVER_USER@$SERVER_HOST "
          cd /tmp
          tar -xzf backend-deployment.tar.gz
          rsync -av deployment-package/ $DEPLOY_PATH/
          cd $DEPLOY_PATH
          npm install --production
          pm2 restart ecosystem.config.cjs || pm2 start ecosystem.config.cjs
        "
